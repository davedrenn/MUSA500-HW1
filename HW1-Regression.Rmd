---
title: "HW1-OLS_Regression"
output: html_document
date: "2023-10-19"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(tidyverse)
library(kableExtra)
library(sf)
library(gridExtra)
library(MASS)
library(DAAG)

options(scipen = 999)
```

# Introduction

# Methods
## Data Cleaning

## Exploratory Data Analysis

## Multiple Regression Analysis

## Additional Analyses

## Software

# Results

## Exploratory Results

```{r data}

data <- read.csv("Data/RegressionData.csv")

```

```{r histogram}

```

```{r table}

summary_stats_mean <- data %>%
  summarise(HEDVAL = mean(MEDHVAL),
            PCTBACHMOR = mean(PCTBACHMOR),
            NBELPOV100 = mean(NBELPOV100),
            PCTVACANT = mean(PCTVACANT),
            PCTSINGLE = mean(PCTSINGLES)) %>%
  gather(key = "variable", value = "mean")
            
summary_stats_sd <- data %>%
  summarise(HEDVAL = sd(MEDHVAL),
            PCTBACHMOR = sd(PCTBACHMOR),
            NBELPOV100 = sd(NBELPOV100),
            PCTVACANT = sd(PCTVACANT),
            PCTSINGLE = sd(PCTSINGLES)) %>%
  gather(key = "variable", value = "sd") %>%
  mutate(row_names = c('Median House Value','# Households Living in Poverty','% of Individuals with Bachelor Degrees or Higher','% of Vacant Houses','% of Single House Units')) 

left_join(summary_stats_mean, summary_stats_sd, by='variable') %>%
  dplyr::select('row_names','mean','sd') %>%
  kbl(col.names = c('Variable','Mean','Standard Deviation')) %>%
  kable_classic()
  
```

# quick code that cehcks which variables have 0 values for logarithmic transformation 
```{r 0_value_check2}
zero_columns <- apply(data, 2, function(col) any(col == 0)) 

variables_with_zero_values <- names(zero_columns[zero_columns])

cat("Columns with 0 values:", paste(variables_with_zero_values, collapse = ", "))

```

```{r log_trans}
data$LNMEDHVAL <- log(data$MEDHVAL)
data$LNPCTBACHMOR <- log(1 + data$PCTBACHMOR)
data$LNBELPOV100 <- log(1 + data$NBELPOV100)
data$LNPCTVACANT <- log(1 + data$PCTVACANT)
data$LNPCTSINGLES <- log(1 + data$PCTSINGLES)
```


```{r hist_MEDHVAL}
par(mfrow=c(1,2))
hist(data$MEDHVAL,breaks=50)
hist(data$LNMEDHVAL,breaks=50)
```


```{r hist_PCTBACHMOR}
par(mfrow=c(1,2))
hist(data$PCTBACHMOR,breaks=50)
hist(data$LNPCTBACHMOR,breaks=50)
```


```{r hist_NBELPOV100}
par(mfrow=c(1,2))
hist(data$NBELPOV100,breaks=50)
hist(data$LNBELPOV100,breaks=50)
```


```{r hist_PCTVACANT}
par(mfrow=c(1,2))
hist(data$PCTVACANT,breaks=50)
hist(data$LNPCTVACANT,breaks=50)
```


```{r hist_PCTSINGLES}
par(mfrow=c(1,2))
hist(data$PCTSINGLES,breaks=50)
hist(data$LNPCTSINGLES,breaks=50)
```

# Scatter Plots - Looking at linearity between dependent variable (LNMEDHVAL) and predictors (LNNBELPOV100,data$PCTBACHMOR, data$PCTVACANT, data$PCTSINGLES  )  
 
```{r scatter}
par(mfrow=c(2,2))
plot(data$LNBELPOV100, data$LNMEDHVAL)
plot(data$PCTBACHMOR,data$LNMEDHVAL)
plot(data$PCTVACANT, data$LNMEDHVAL)
plot(data$PCTSINGLES, data$LNMEDHVAL)
```

# Pearson correlations

```{r pearson}
predictors <- as.matrix(cbind(data$PCTBACHMOR, data$PCTVACANT,data$PCTSINGLES,data$LNBELPOV100 ))

cor(predictors) %>% as.data.frame.table() %>% 
  spread(key='Var2',value='Freq') %>% 
  mutate(row_name = c('PCTBACHMOR','PCTVACANT','PCTSINGLES','LNBELPOV100')) %>%
  dplyr::select('row_name','A','B','C','D') %>%
  kbl(col.names = c('','PCTBACHMOR','PCTVACANT','PCTSINGLES','LNBELPOV100')) %>%
  kable_classic()
```

```{r LNMEDHVAL map}

# Change design
map <- st_read("Data/RegressionData.shp")

ggplot() +
  geom_sf(data = map, aes(fill = LNMEDHVAL), color = NA) +
  scale_fill_gradient(low = "white",high = "darkseagreen4") +
  labs(title = "Log Median Home Value")

```

```{r variables maps, fig.width = 12}
# Change designs
pctvacant_map <- ggplot() +
  geom_sf(data = map, aes(fill = PCTVACANT), color = NA) +
  scale_fill_gradient(low = "white",high = "darkblue") +
  labs(title = "Vacant",
       fill = "%")

pctsingles_map <- ggplot() +
  geom_sf(data = map, aes(fill = PCTSINGLES), color = NA) +
  scale_fill_gradient(low = "white",high = "darkorchid4") +
  labs(title = "Singles",
       fill = "%")

pctbachmor_map <- ggplot() +
  geom_sf(data = map, aes(fill = PCTBACHMOR), color = NA) +
  scale_fill_gradient(low = "white",high = "darkorange") +
  labs(title = "Bachelor's or More",
       fill = "%")

lnnbelpov100_map <- ggplot() +
  geom_sf(data = map, aes(fill = LNNBELPOV), color = NA) +
  scale_fill_gradient(low = "white",high = "darkred") +
  labs(title = "Log Below Poverty",
       fill = "%")

grid.arrange(pctvacant_map, pctsingles_map, pctbachmor_map, lnnbelpov100_map)

```

```{r regression}
## Regression Results

fit <-lm(LNMEDHVAL ~  PCTVACANT + PCTSINGLES + PCTBACHMOR + LNBELPOV100, data=data)

summary(fit)

anova(fit)
```

```{r plot_stand_resid}
##predicted values, residuals and standardized residuals

#Predicted values (y-hats)
data$predvals <- fitted(fit) 
#Residuals
data$resids <- residuals(fit)
#Standardized Residuals
data$stdres <- rstandard(fit)

plot(data$predvals, data$stdres, xlab = "Predicted Values ", ylab = "Standardized Residuals ", main = "Predicted Values vs.Standardized Residuals ")
```
```{r plot_stepwise}

step <- stepAIC(fit, direction="both")
# display results
step$anova

```

```{r cross-validation, message=FALSE, cache=FALSE,  echo=TRUE, results='hide', fig.show='hide'}

fit1 <- lm(LNMEDHVAL ~ PCTVACANT + PCTSINGLES + PCTBACHMOR + LNBELPOV100, data=data)
cv1 <- CVlm(data=data, fit1, m=5)

mse1 <- attr(cv1, "ms")
rmse1 <- sqrt(mse1)						  #Obtaining RMSE for model 1
rmse1



fit2 <- lm(LNMEDHVAL ~ PCTVACANT + MEDHHINC, data=data)
cv2 <- CVlm(data=data, fit2, m=5)

mse2 <- attr(cv2, "ms")
rmse2 <- sqrt(mse2)						  #Obtaining RMSE for model 2
rmse2

```


## Regression Assumptions Checks

## Additional Models

# Discussion and Limitations